<html>
<head>
<title>История &gt; Географическая &gt; Заметки &gt; &laquo;Советы по&nbsp;написанию триггеров&raquo;</title>
<link rel=stylesheet href='../../mudhistory.css' type="text/css">
</head>
<body>
<center class="navbar"><a href="../../index.html">Главная</a>&nbsp;|&nbsp;<a href="../../fiz/index.html">Физика</a>&nbsp;&nbsp;<b>География</b>&nbsp;&nbsp;<a href="../../clans/index.html">Политика</a>&nbsp;|&nbsp;<a href="../../sources.html">Источники</a>&nbsp;&nbsp;<a href="../../about.html">О проекте</a></center>
<center class="navbar"><a href="../../index.html">История</a>&nbsp;/&nbsp;<a href="../index.html">Географическая</a>&nbsp;/&nbsp;<a href="index.html">Заметки</a>&nbsp;/&nbsp;<b>Советы по написанию триггеров</b></center>
<hr>
<h1>Советы по&nbsp;написанию триггеров<br>для МПМ &laquo;Былины&raquo;,</h1>
<h2>или &laquo;Почему оно тикает&raquo;</h2>
<hr>

<h3>Предисловие</h3>
<p>Здравствуйте! Итак, перед вами &laquo;учебник&raquo; по&nbsp;написанию триггеров для МПМ &laquo;Былины&raquo;. Слово это взято в&nbsp;кавычки, ибо ни&nbsp;по&nbsp;своему объему, ни&nbsp;по&nbsp;содержательности этот текст все&nbsp;же не&nbsp;тянет на&nbsp;полноценное учебное пособие :). Учитывая, что это первый опыт написания подобного текста, автор просит простить ему излишнюю назидательность и&nbsp;прочие огрехи. Критика, дополнения и&nbsp;указания на&nbsp;неточности и&nbsp;ошибки, просьбы о&nbsp;написании дополнительных разделов и&nbsp;глав&nbsp;&#151; приветствуются и&nbsp;принимаются по&nbsp;мад-почте на&nbsp;имя Горраха.</p>
<p>Предупреждаю заранее&nbsp;&#151; учебник не&nbsp;содержит и&nbsp;не&nbsp;будет содержать в&nbsp;дальнейшем подробного описания возможностей DGScript&nbsp;&#151; для этого существует спецификация, выложенная на&nbsp;странице МПМ &laquo;Былины&raquo; в&nbsp;разделе &laquo;Файлы&raquo;. Впрочем, удовлетворение от&nbsp;хорошо проделанной работы по&nbsp;созданию красивой и&nbsp;гибкой зоны при помощи DGScript вполне компенсирует время и&nbsp;усилия, потраченные на&nbsp;его освоение. Желаю удачи и&nbsp;творческих успехов в&nbsp;работе билдера!</p>

<h3>Часть 1<br>Зачем они нам?</h3>
<p>Первый вопрос начинающего билдера: &laquo;А&nbsp;для чего вообще нужны триггера?&raquo;</p>
<p>Мир МПМ-игры достаточно гибок, и&nbsp;очень многие эффекты можно создать, просто проставив мобам и&nbsp;предметам соответствующие параметры. Тем не&nbsp;менее&nbsp;&#151; количество возможных игровых ситуаций безгранично, и&nbsp;для обработки этих событий и&nbsp;ситуаций предусмотрен специальный язык разработки программ-&laquo;триггеров&raquo;, который называется DGscript. Это &laquo;техническая&raquo; сторона дела. Если&nbsp;же обратиться к&nbsp;творчеству&nbsp;&#151; то&nbsp;триггера могут сделать вашу зону по-настоящему оригинальной и&nbsp;интересной, создать необычные эффекты, образовать запутанный и&nbsp;увлекательный квест. Зона, не&nbsp;содержащая триггеров, по&nbsp;сути представляет собой просто некий объем пространства, по&nbsp;которому бродят предназначенные к&nbsp;убиению слепоглухонемые мобы. Хотя, разумеется, если вы&nbsp;в&nbsp;состоянии писать описания так, как это сделано в&nbsp;&laquo;Трех дорогах&raquo;&nbsp;&#151; это может, до&nbsp;некоторой степени, служить компенсацией :). &laquo;Научить&raquo;&nbsp;же мобов, объекты и&nbsp;комнаты вести себя нестандартным образом, реагировать на&nbsp;разнообразные действия игрока можно лишь с&nbsp;помощью DGScript.</p>
<p>Итак, если вы&nbsp;хотите писать не&nbsp;сырые &laquo;полуфабрикаты&raquo;, а&nbsp;законченные и&nbsp;работоспособные зоны и&nbsp;желаете изучить язык триггеров, первое, что вы&nbsp;должны сделать, это скачать с&nbsp;<a href="https://www.bylins.su">сайта &laquo;Былин&raquo;</a> из&nbsp;раздела &laquo;Файлы&raquo; документацию по&nbsp;DGscript (DGSinfo). Последняя на&nbsp;момент написания версия этого документа носит номер 4.&nbsp;Я&nbsp;не&nbsp;стану описывать здесь подробности языка, лишь приведу несколько примеров. Кроме того, если вы&nbsp;владеете любым языком программирования, то&nbsp;нелишним будет просмотреть исходные коды интерпретатора триггеров.</p>

<h3>Часть 2<br>С чего начать?</h3>
<p>К сожалению, многие начинающие билдеры, познакомившись с&nbsp;DGscript, начинают плодить бесконечные клоны квестов &laquo;главаря&raquo; по&nbsp;типу &laquo;сходи-убей-(принеси вещь)&raquo;: Поэтому желательно, поняв принципы написания триггеров, накрепко позабыть все, что вы&nbsp;до&nbsp;этого видели&nbsp;&#151; и&nbsp;придумывать что-то свое, чего еще никто не&nbsp;делал :). Пример тому&nbsp;&#151; квест тридевятого царства. Многие из&nbsp;его элементов стандартны, но&nbsp;весь квест в&nbsp;целом создает впечатления оригинального.</p>
<p>Если квест достаточно сложен&nbsp;&#151; лучше кратко записать его сюжетную линию. После этого можно уже взглянуть на&nbsp;него глазами кодера и&nbsp;прикинуть, что из&nbsp;придуманного реализовать невозможно или слишком сложно. Нередко бывает, что от&nbsp;изобретенных сюжетных поворотов и&nbsp;элементов приходится отказываться или упрощать их,&nbsp;иногда даже приходится начинать работу заново&nbsp;&#151; но&nbsp;в&nbsp;целом язык триггеров достаточно гибок, и&nbsp;не&nbsp;так просто придумать вещь, которая вообще&nbsp;бы не&nbsp;решалась в&nbsp;нем.</p>
<p>После того, как придуман и&nbsp;оценен квест, пришла пора разбить его по&nbsp;триггерам&nbsp;&#151; то&nbsp;бишь определить, что и&nbsp;из&nbsp;какого триггера будет выполняться. Сразу замечу&nbsp;&#151; иной раз лучше написать несколько простых триггеров и&nbsp;подключать их&nbsp;по&nbsp;выбору, чем накручивать один грандиозный триггер со&nbsp;множеством проверок. Чем сложнее скрипт&nbsp;&#151; тем больше вероятность сделать ошибку, причем вы&nbsp;вполне можете не&nbsp;суметь обнаружить ее&nbsp;при тестировании квеста, поскольку предусмотренные вами условия никогда не&nbsp;наступят. И&nbsp;тогда ошибка (может даже крешащая) &laquo;всплывет&raquo; уже на&nbsp;сервере, если только проверявший вашу зону иммортал не&nbsp;окажется бдительней вас.</p>
<p>Еще одна ошибка начинающего билдера&nbsp;&#151; стремление делать все и&nbsp;вся при помощи триггеров, тогда как очень многое решается при помощи расстановки флагов мобам и&nbsp;назначении им&nbsp;и&nbsp;предметам описаний. Здесь работает то&nbsp;же правило, что и&nbsp;при решении любой другой технической задачи&nbsp;&#151; чем проще, тем лучше, то&nbsp;есть из&nbsp;возможных реализаций квеста (даже достаточно сложного) наилучшей является та,&nbsp;что насчитывает наименьшее количество наиболее простых триггеров.</p>

<h3>Часть 3<br>Основные понятия</h3>
<p>Для написания триггеров вовсе необязательно быть программистом и&nbsp;знать языки программирования (хотя в&nbsp;этом случае освоить DG&nbsp;script значительно легче), но&nbsp;следует все&nbsp;же усвоить некоторые основные понятия. Итак&#133;</p>
<p class="list1">1. <b>Игровыми объектами</b> в&nbsp;МПМ &laquo;Былины&raquo; являются а)&nbsp;<i>мобы</i> (или игроки&nbsp;&#151; хотя к&nbsp;игроку (так, во&nbsp;всяком случае, считается :)) нельзя подключить триггера);&nbsp;б) <i>предметы</i>; в)&nbsp;<i>комнаты</i>. Каждый объект обладает некоторым количеством характеристик&nbsp;&#151; <b>свойств</b>, количество и&nbsp;значение которых зависят от&nbsp;типа объекта, от&nbsp;его подтипа (например, предмет может быть оружием, а&nbsp;может свитком или магическим напитком) и&nbsp;даже конкретного экземпляра данного объекта.</p>
<p class="list1">2. <b>Триггером</b> называется прикрепленная к&nbsp;игровому объекту программа на&nbsp;языке DGscript, выполнение которой происходит при некоторых заранее определенных условиях. Существует три типа триггеров&nbsp;&#151; триггера мобов, комнат и&nbsp;объектов. У&nbsp;каждого из&nbsp;этих типов есть подтипы, от&nbsp;которых зависят условия срабатывания триггера. Например, триггер может вызываться, когда вы&nbsp;сказали какую-либо фразу, когда вы&nbsp;дали мобу предмет или деньги и&nbsp;т.д.</p>
<p class="list1">3. <b>Скриптом</b> называется весь список триггеров, подключенных к&nbsp;данному игровому объекту.</p>
<p class="list1">4. <b>Переменной</b> называется некоторая поименованная величина, <i>значение</i> которой может меняться в&nbsp;ходе выполнения программы (скрипта). Хотя точное значение переменной, как правило, заранее не&nbsp;известно, но&nbsp;<i>тип</i> (строка, число, указатель и&nbsp;т.п.) обычно известен и&nbsp;должен учитываться при обработке значений переменных.</p>
<p class="list1">5. <b>Оператором языка</b> называется заранее определенная разработчиками DGscript команда, введение которой в&nbsp;текст триггера вызывает выполнение определенных действий. Например, оператор <tt>wait</tt><tt class="arg"> 1s</tt>&nbsp;вызовет остановку выполнения триггера на&nbsp;1&nbsp;секунду (или на&nbsp;другое, указанное в&nbsp;параметре время), а&nbsp;оператор <tt>halt</tt> прекращает выполнение текущего триггера.</p>
<p class="list1">6. <b>ID&nbsp;объекта</b>. То,&nbsp;что вы&nbsp;создаете в&nbsp;редакторе, не&nbsp;есть, собственно, &laquo;мобы&raquo; и&nbsp;&laquo;предметы&raquo;. Это описание <i>класса</i> объектов, исходя из&nbsp;которого движок игры создаст <i>экземпляры класса</i>. То,&nbsp;что какой-то моб или предмет может присутствовать в&nbsp;игре в&nbsp;единственном экземпляре, роли не&nbsp;играет. Приведу аналогию. Вы&nbsp;создаете &laquo;штамп&raquo;. А&nbsp;каждый моб или предмет с&nbsp;заданными вами характеристиками&nbsp;&#151; это &laquo;отпечаток&raquo; штампа. Тогда возникает вопрос&nbsp;&#151; как&nbsp;же отличать друг от&nbsp;друга объекты, созданные с&nbsp;одного &laquo;штампа&raquo;? Для этого и&nbsp;существует идентификатор&nbsp;&#151; ID.&nbsp;В&nbsp;мире не&nbsp;может быть двух объектов с&nbsp;одинаковыми идентификаторами. Таким образом, идентификатор создает ссылку на&nbsp;один-единственный, вполне определенный экземпляр-&laquo;отпечаток&raquo;. ID&nbsp;&#151; это не&nbsp;то&nbsp;же самое, что и&nbsp;<tt class="var">vnum</tt>. Следуя аналогии, <tt class="var">vnum</tt>&nbsp;&#151; это номер &laquo;штампа&raquo; (описания класса), а&nbsp;ID&nbsp;&#151; &laquo;номер&raquo; отпечатка. (Учтите, ID&nbsp;&#151; это не&nbsp;число! Поэтому не&nbsp;стоит пытаться проводить над ним арифметические операции.)</p>
<p>Предположим, вы&nbsp;имеете указатель на&nbsp;некоторого персонажа, помещенный в&nbsp;переменную. Это может быть стандартный указатель, создаваемый при запуске триггера (например, многие триггера помещают в&nbsp;переменную <tt class="var">actor</tt> указатель на&nbsp;игрока/моба, вызвавшего запуск триггера). Или вы&nbsp;сами поместите в&nbsp;переменную указатель на&nbsp;игрока: <tt class="script">eval</tt><tt class="arg"> char</tt><tt class="var"> %random.pc%</tt>&nbsp;&#151; помещаем в&nbsp;переменную <tt class="var">char</tt> указатель случайного игрока, находящегося в&nbsp;комнате с&nbsp;этим триггером. Тогда выражение <tt class="var">%переменная.поле%</tt> вызывает обращение к&nbsp;какому-либо свойству данного объекта (имя моба/игрока/предмета, статсы и&nbsp;т.п.). Например: <tt class="var">%char.name%</tt>&nbsp;&#151; имя игрока, ссылка на&nbsp;которого была помещена в&nbsp;переменную <tt class="var">char</tt>. <tt class="var">%char.id%</tt>&nbsp;&#151; ID&nbsp;этого игрока, <tt class="var">%char.str%</tt>&nbsp;&#151; сила игрока и&nbsp;т.д.</p>

<h3>Часть 4<br>Грабли</h3>
<p>По возможности я&nbsp;постарался здесь перечислить наиболее частые ошибки, встречавшиеся мне как в&nbsp;собственных, так и&nbsp;в&nbsp;написанных другими билдерами триггерах. Собрано с&nbsp;миру по&nbsp;нитке&nbsp;&#151; что вспомнилось.</p>
<p>Триггер выполняется, только если а)&nbsp;он&nbsp;подключен к&nbsp;какому-либо объекту и&nbsp;б) объект, к&nbsp;которому подключен триггер, существует все время, необходимое для выполнения триггера. При нарушении любого из&nbsp;этих двух условий выполнение триггера будет немедленно прервано. Одна из&nbsp;самых распространенных ошибок начинающего билдера&nbsp;&#151; попытки что-либо сделать в&nbsp;триггере после его отключения (<tt>detach</tt>) от&nbsp;объекта, или после уничтожения (<tt>purge</tt>) самого объекта. По&nbsp;этой&nbsp;же причине не&nbsp;выполняется часть <tt>mob_death</tt> триггера, расположенная после команды <tt>wait</tt>&nbsp;&#151; при этой команде выполнение триггера временно приостанавливается и&nbsp;выполняются другие команды мира. В&nbsp;том числе команда &laquo;извлечения&raquo; моба, смерть которого вызвала срабатывание триггера&nbsp;&#151; и&nbsp;моб вместе с&nbsp;триггером будет удален из&nbsp;игры.</p>
<p>Когда вы&nbsp;обращаетесь к&nbsp;произвольной переменной следующим образом: <tt class="var">%variable%</tt>, интерпретатор ищет уже существующую переменную с&nbsp;таким именем и&nbsp;подставляет ее&nbsp;значение на&nbsp;место взятого в&nbsp;проценты выражения. Если такой переменной нет&nbsp;&#151; будет подставлено пустое значение. Если&nbsp;же вы&nbsp;хотите обратиться не&nbsp;к&nbsp;значению переменной, а&nbsp;к&nbsp;ней самой, ее&nbsp;название надо употребить без знаков процента. например <tt>global</tt><tt class="var"> var1</tt>&nbsp;&#151; эта команда сделает переменную <tt class="var">var1</tt>&nbsp;глобальной. <strike><tt>global</tt><tt class="var"> %var1%</tt></strike>&nbsp;&#151; неправильно; если переменная <tt class="var">var1</tt>&nbsp;содержит, например, значение <tt class="mud">&laquo;123&raquo;</tt>, то&nbsp;получим <tt>global</tt><tt class="var"> 123</tt>&nbsp;&#151; интерпретатор попытается найти и&nbsp;сделать глобальной переменную <tt class="var">123</tt>, а&nbsp;переменной с&nbsp;таким именем, вероятней всего, не&nbsp;существует. </p>
<p>Третья по&nbsp;распространенности ошибка&nbsp;&#151; ожидание того, что в&nbsp;момент перезагрузки зоны все триггера и&nbsp;вся зона придут к&nbsp;исходному состоянию. Это не&nbsp;так. Все отключенные и&nbsp;подключенные триггера, созданные переменные, переходы и&nbsp;двери между комнатами, загруженные мобы (если только вы&nbsp;не&nbsp;вписали их&nbsp;в&nbsp;список мобов, удаляемых при перезагрузке) останутся в&nbsp;прежнем виде, поэтому необходимо ресторить зону, подключая все триггера и&nbsp;уничтожая, если это необходимо, проходы из&nbsp;триггера. Обычно для этого используется выполняемый при перезагрузке зоны wld-триггер.</p>
<p>Глобальные переменные. Переменная, объявленная глобальной, существует столько&nbsp;же времени, сколько и&nbsp;сам объект, к&nbsp;которому она относится. Она доступна изо всех триггеров данного объекта, однако чтобы она стала доступна и&nbsp;в&nbsp;триггере какого-либо другого объекта, ее&nbsp;надо скопировать в&nbsp;окружение этого другого объекта командой remote. При этом создается независимая глобальная переменная с&nbsp;тем&nbsp;же именем, т.е. если вы&nbsp;измените значение этой переменной, это не&nbsp;отразится на&nbsp;копиях переменной. (Кроме того, по&nbsp;моим экспериментам после присваивания глобальной переменной нового значения, ее&nbsp;необходимо снова объявлять глобальной, иначе она рассматривается как обычная и&nbsp;уничтожается по&nbsp;завершению скрипта.) Если&nbsp;же вы&nbsp;хотите использовать переменную, доступную из&nbsp;любого триггера и&nbsp;содержащую значение, одинаковое для любого триггера и&nbsp;объекта&nbsp;&#151; надо использовать мировые (&laquo;world&raquo;) переменные.</p>
<p>Делать этого, впрочем, не&nbsp;рекомендуется. В&nbsp;99%&nbsp;случаев глобальная переменная после копирования не&nbsp;требует согласования с&nbsp;исходной переменной&nbsp;&#151; обычно глобальные переменные используют, чтобы &laquo;запомнить&raquo; игрока или поставить &laquo;метку&raquo; о&nbsp;выполнении какого-либо условия. Мировые&nbsp;же переменные очень капризны и&nbsp;обладают существенным недостатком&nbsp;&#151; их&nbsp;необходимо уничтожать вручную, о&nbsp;чем вполне можно забыть или сделать это некорректно. Глобальные&nbsp;же переменные уничтожаются при извлечении объекта, к&nbsp;которому принадлежат, при этом высвобождается и&nbsp;занимаемая ими память (хотя желательно, а&nbsp;иногда и&nbsp;обязательно для работы квеста уничтожать эти переменные при перезагрузке зоны). </p>
<p>Еще одна распространенная ошибка&nbsp;&#151; употребление в&nbsp;триггерах мобов команд наподобие <tt>wecho</tt> вместо <tt>mecho</tt> и&nbsp;наоборот. Чтобы избежать этого, используйте команды-переменные <tt>%echo%</tt>, <tt>%send%</tt> и&nbsp;т.д.&nbsp;&#151; интерпретатор автоматически подставит на&nbsp;их&nbsp;место команды, необходимые по&nbsp;типу триггера.</p>
<p>Распространенная ошибка&nbsp;&#151; опечатки в&nbsp;переменных. Как и&nbsp;любая программа, интерпретатор триггеров делает то,&nbsp;что вы&nbsp;сказали ему делать, а&nbsp;не&nbsp;то,&nbsp;что бы вы&nbsp;хотели сделать. Если вы&nbsp;создадите, например, переменную <tt class="var">%questor99%</tt>, а&nbsp;затем обратитесь к&nbsp;переменной <tt class="var">%questro99%</tt>, интерпретатор будет обрабатывать несуществующую переменную <tt class="var">%questro99%</tt>, т.е. пустое значение. Вроде&nbsp;бы тривиально, но&nbsp;эта ошибка едва&nbsp;ли не&nbsp;одна из&nbsp;самых частых и,&nbsp;кстати, труднонаходимых.</p>
<p>Операторы циклов и&nbsp;условий. Конструкции <tt>if-elseif-else-end</tt>, <tt>while-done</tt>, <tt>foreach-done</tt>, <tt>switch-case-break-&#133;-done</tt> предоставляют очень удобные возможности, но&nbsp;создают опасность возникновения бесконечного цикла, что приводит к&nbsp;мгновенному падению или зависанию сервера. Бесконечный цикл может возникнуть при отсутствии оператора завершения цикла <tt>end</tt> или <tt>done</tt> или неверно заданных условиях. Например, если выражение, заданное в&nbsp;качестве условия в&nbsp;операторе <tt>while-done</tt>, будет всегда истинным, возникнет бесконечный цикл.</p>

<h3>Часть 5<br>Еще несколько примеров</h3>
<p>В качестве общеизвестных примеров триггеров взяты:</p>
<p class="list1"><a href="example1.txt">телепортящий триггер у&nbsp;цыган</a> в&nbsp;1&nbsp;и&nbsp;2 родовой деревне;</p>
<p class="list1"><a href="example2.txt">квест на&nbsp;главаря разбойников;</a></p>
<p class="list1"><a href="example3.txt">квест на&nbsp;кладбище</a> около 1&nbsp;родовой деревни.</p>

<h3>Часть 6<br>Немного практики</h3>
<p>Рассмотрим пример написания простого квеста. Он&nbsp;как раз из&nbsp;области &laquo;сходи-принеси&raquo;, поэтому не&nbsp;надейтесь почерпнуть здесь оригинальную идею. Сюжет: некий старик жалуется путнику, что разбойники его ограбили, причем, что самое главное, кроме денег похитили мешок с&nbsp;учеными книгами, без которого этому бедняге и&nbsp;жизнь не&nbsp;мила.</p>
<p>Проводим разбиение сюжета по&nbsp;триггерам:</p>
<p class="list1">1&nbsp;триггер&nbsp;&#151; старик приветствует и&nbsp;просит помощи;</p>
<p class="list1">2&nbsp;триггер&nbsp;&#151; старик дает задание;</p>
<p class="list1">3&nbsp;триггер&nbsp;&#151; старик выдает награду при получении нужного объекта;</p>
<p class="list1">4&nbsp;триггер&nbsp;&#151; восстановление зоны после выполнения квеста, с&nbsp;учетом того, что квест может быть выполнен не&nbsp;полностью.</p>
<p>Вполне возможно, что по&nbsp;ходу квеста придется выполнить еще какие-то действия (загрузить предмет и&nbsp;т.п.), тогда придется добавить еще несколько триггеров.</p>
<p>Необходимый инвентарь:</p>
<p class="list1">Мобы:</p>
<p class="list2">1.&nbsp;Седой старик (номер 100)<br>
2.&nbsp;Страшный злобный разбойник (101)<br>
3.&nbsp;Молодой неопытный разбойник (102)</p>
<p class="list1">Объекты:</p>
<p class="list2">1.&nbsp;Мешок книгочея (100)<br>
2.&nbsp;Калита с&nbsp;монетами (101)<br>
3.&nbsp;Крепкий сундук (102)<br>
4.&nbsp;Длинный ключ (103)<br>
5.&nbsp;Разбойничий жупан (104)&nbsp;&#151; можно надеть на&nbsp;тело</p>
<p>Крепкий сундук ставим в&nbsp;пещере у&nbsp;разбойников, в&nbsp;него кладем калиту и&nbsp;мешок, перед входом в&nbsp;пещеру ставим страшного разбойника, а&nbsp;молодого пускаем гулять чуть поодаль, облачив его в&nbsp;разбойничий жупан.</p>
<p>Первый триггер&nbsp;&#151; приветствие у&nbsp;старика. Триггер типа<tt> mob_PC_enter</tt>, номер <tt class="var">100</tt>, числовой аргумент <tt class="var">100</tt>.</p>
<pre>
<tt class="script">wait</tt> <tt class="arg">1</tt>
<tt class="mud">say</tt> <tt class="text">Поздорову!</tt>
<tt class="mud">вздох</tt>
<tt class="mud">say</tt> <tt class="text">Присаживайся - отдохни с дороги...</tt>
<tt class="mud">say</tt> <tt class="text">Меня Рашив-книгочей зовут...</tt>
<tt class="mud">дум</tt>
<tt class="script">wait</tt> <tt class="arg">1s</tt>
<tt class="mud">say</tt> <tt class="text">Беда тут со мной приключилась...</tt>
<tt class="mud">say</tt> <tt class="text">Налетели лихие люди, отняли суму мою с деньгами и мешок с книгами.</tt>
<tt class="script">wait</tt> <tt class="arg">1s</tt>
<tt class="mud">say</tt> <tt class="text">И бог бы с ними, с деньгами - недалече уж мне до дому...</tt>
<tt class="mud">say</tt> <tt class="text">А вот книги...</tt>
<tt class="mud">вопрос</tt> <tt class="var">%actor.name%</tt>
<tt class="mud">say</tt> <tt class="text">Может, ты сумеешь вернуть их?</tt>
<tt class="script">detach</tt> <tt class="arg">100</tt> <tt class="var">%self.id%</tt>
</pre>
<p>Второй триггер <tt>mob_speech</tt>, номер <tt class="arg">101</tt>. Аргумент: <tt class="arg">согласен смогу слушаю</tt>, числовой аргумент: <tt class="arg">1</tt>.</p>
<pre>
<tt class="script">if</tt> <tt class="var">%actor.vnum</tt> <tt class="arg">!= -1</tt>
    <tt class="rem">*проверяем, не моб ли это говорит, если да - завершаем триггер</tt>
    <tt class="script">halt</tt>
<tt class="script">end</tt>
<tt class="script">makeuid</tt> <tt class="arg">questor100</tt> <tt class="var">%actor.id%</tt>
<tt class="script">global</tt> <tt class="arg">questor100</tt>
<tt class="rem">*создаем копию переменной actor и делаем ее глобальной</tt>
<tt class="script">wait</tt> <tt class="arg">1s</tt>
<tt class="mud">улы</tt>
<tt class="mud">say</tt> <tt class="text">Сами Боги послали мне тебя!</tt>
<tt class="mud">say</tt> <tt class="text">Вот туда эти презренные удалились.</tt>
<tt class="mud">emot</tt> <tt class="text">махнул рукой куда-то на восток</tt>
<tt class="script">wait</tt> <tt class="arg">1s</tt>
<tt class="mud">say</tt> <tt class="text">Я, пожалуй, тут подожду.</tt>
<tt class="mud">жда</tt>
<tt class="script">attach</tt> <tt class="arg">102</tt> <tt class="var">%self.id%</tt>
<tt class="script">detach</tt> <tt class="arg">100</tt> <tt class="var">%self.id%</tt>
<tt class="script">detach</tt> <tt class="arg">101</tt> <tt class="var">%self.id%</tt>
</pre>
<p>Триггер <tt>mob_receive</tt>, номер <tt class="arg">102</tt> (мобу дали предмет). Числовой аргумент: <tt class="arg">100</tt>.</p>
<pre>
<tt class="script">if</tt> <tt class="var">%object.vnum%</tt> <tt class="arg">!= 100</tt>
    <tt class="mud">say</tt> <tt class="text">Спасибо, но это не моя вещь!</tt>
    <tt class="mud">дать</tt> <tt class="var">%object.name%</tt> <tt class="var">%actor.name%</tt>
    <tt class="script">halt</tt>
<tt class="script">end</tt>
<tt class="script">if</tt> <tt class="var">%actor.id%</tt> <tt class="arg">!=</tt> %questor100.id%</tt>
    <tt class="rem">*Если предмет дал не тот кто брал квест</tt>
    <tt class="script">wait</tt> <tt class="arg">2</tt>
    <tt class="mud">say</tt> <tt class="text">Я не тебя просил о помощи, но все равно спасибо!</tt>
    <tt class="mud">поклон</tt> <tt class="var">%actor.name%</tt>
    <tt class="script">wait</tt> <tt class="arg">1</tt>
    <tt class="mud">stand</tt>
    <tt class="script">%echo%</tt> <tt class="text">Старик удалился по дороге на север.</tt>
    <tt class="script">mjunk</tt> <tt class="arg">all</tt>
    <tt class="rem">*Удаляем все предметы из инвентаря</tt>
    <tt class="script">wait</tt> <tt class="arg">1</tt>
    <tt class="script">%purge%</tt> <tt class="var">%self%</tt>
    <tt class="rem">*И удаляем моба</tt>
    <tt class="script">halt</tt>
<tt class="script">end</tt>
<tt class="rem">*И, наконец, если дали то, что нужно и тот, кто должен - НАГРАДА!</tt>
<tt class="mud">say</tt> <tt class="text">Вот спасибо тебе,</tt> <tt class="var">%actor.name%!</tt>
<tt class="script">mload</tt> <tt class="arg">obj</tt> 105</tt>
<tt class="script">wait</tt> <tt class="arg">1</tt>
<tt class="rem">*Загружаем четверть водки :)</tt>
<tt class="mud">дать четверть</tt> <tt class="var">%actor.name%</tt>
<tt class="mud">поклон</tt> <tt class="var">%actor.name%</tt>
<tt class="script">wait</tt> <tt class="arg">1</tt>
<tt class="mud">stand</tt>
<tt class="script">%echo%</tt> <tt class="text">Старик удалился по дороге на север.</tt>
<tt class="script">mjunk</tt> <tt class="arg">all</tt>
<tt class="rem">*Удаляем все предметы из инвентаря</tt>
<tt class="script">%purge%</tt> <tt class="var">%self%</tt>
<tt class="rem">*И удаляем моба</tt>
</pre>
<p>Нам понадобится еще один триггер для загрузки ключа. Можно, разумеется, просто положить его в&nbsp;инвентарь к&nbsp;разбойнику, но&nbsp;лучше загрузить. Самый распространенный вариант&nbsp;&#151; загрузить ключ в&nbsp;момент смерти моба.</p>
<p>Триггер <tt>mob_death</tt>, номер <tt class="arg">103</tt>, числовой аргумент: <tt class="arg">100</tt>. Подключаем к&nbsp;молодому разбойнику.</p>
<pre>
<tt class="script">mload</tt> <tt class="arg">obj</tt> 103</tt>
</pre>
<p>Можно сделать квест чуть интересней. Конечно, никто не&nbsp;мешает просто убить злобного разбойника&#133; Но&nbsp;можно его обхитрить.</p>
<p>Итак. Триггер <tt>mob_PC_Enter</tt>, номер <tt class="arg">104</tt>, числовой аргумент: <tt class="arg">100</tt>.</p>
<pre>
<tt class="script">eval</tt> <tt class="arg">item</tt> <tt class="var">%actor.eq(5)%</tt>
<tt class="rem">*получаем указатель на предмет, надетый у вошедшего на теле</tt>
<tt class="script">wait</tt> <tt class="arg">1</tt>
<tt class="script">if</tt> <tt class="var">%item.vnum%</tt> <tt class="arg">!= 104</tt>
    <tt class="rem">*Если предмет НЕ разбойничий жупан, то</tt>
    <tt class="mud">say</tt> <tt class="text">Ты еще кто таков</tt><tt class="var">%actor.g%</tt> ?!</tt>
    <tt class="mud">рыч</tt>
    <tt class="script">mkill</tt> <tt class="var">%actor%</tt>
    <tt class="script">halt</tt>
<tt class="script">end</tt>
<tt class="rem">*Если на теле надет разбойничий жупан, то</tt>
<tt class="mud">приве</tt> <tt class="var">%actor.name%</tt>
</pre>
<p>Ну и&nbsp;конечно, главное. Триггер 103&nbsp;надо подключить к&nbsp;молодому разбойнику, триггер 104&nbsp;&#151; к&nbsp;злобному разбойнику, триггера 100 и&nbsp;101&nbsp;&#151; к&nbsp;старику. Кроме того, необходимо написать триггер для комнат, запускающийся при перезагрузке зоны со&nbsp;100% вероятностью.</p>
<p>Триггер <tt>wld_reset</tt>, номер <tt class="arg">105</tt>, числовой аргумент: <tt class="arg">100</tt>.</p>
<pre>
<tt class="script">calcuid</tt> <tt class="arg">starik 100 mob</tt>
<tt class="rem">*помещаем в переменную ссылку на моба-старика</tt>
<tt class="script">rdelete</tt> <tt class="arg">questor100</tt> <tt class="var">%starik.id%</tt>
<tt class="rem">*удаляем глобальную перменную questor100 с моба 100</tt>
<tt class="script">detach</tt> <tt class="arg">101</tt> <tt class="var">%starik.id%</tt>
<tt class="script">detach</tt> <tt class="arg">102</tt> <tt class="var">%starik.id%</tt>
<tt class="script">detach</tt> <tt class="arg">103</tt> <tt class="var">%starik.id%</tt>
<tt class="script">attach</tt> <tt class="arg">101</tt> <tt class="var">%starik.id%</tt>
<tt class="script">attach</tt> <tt class="arg">102</tt> <tt class="var">%starik.id%</tt>
<tt class="rem">*отключаем от старика все триггера, и подключаем заново необходимые при встрече и взятии квеста</tt>
</pre>
<p>Триггера необходимо отключать, а&nbsp;затем подключать заново, потому что это проще, чем проверять, взял&nbsp;ли кто-то квест и&nbsp;были&nbsp;ли отключены триггера 100 и&nbsp;101.</p>
<p>Все! Квест готов :). Осталось разместить мобов и&nbsp;объекты в&nbsp;зоне и&nbsp;подключить триггер 105&nbsp;к&nbsp;любой комнате зоны. Чтобы тому, кто будет отлаживать вашу зону, не&nbsp;пришлось искать место подключения, лучше всего выбрать комнату 100&nbsp;&#151; первую в&nbsp;зоне.</p>
<p>Небольшое примечание по&nbsp;поводу награды&nbsp;&#151; раз уж&nbsp;старик-книгочей, то&nbsp;куда интересней и&nbsp;реалистичней будет, если он&nbsp;подарит своему добровольному помощнику какую-нибудь книгу из&nbsp;своего мешка.</p>

<h3>Часть 7<br>Поиск ошибок и&nbsp;отладка триггеров</h3>
<p>Как и&nbsp;для любой другой программы, при отладке триггеров сложно обычно не&nbsp;исправить ошибку, а&nbsp;обнаружить ее.&nbsp;Исправление ошибки обычно подразумевает всего лишь исправление опечатки или неверного оператора. Полностью пересматривать логику работы триггера или, тем более, квеста, приходится редко.</p>
<p>Итак, при тестировании зоны вообще&nbsp;&#151; первым делом отмените перезагрузку зоны, проставив ей&nbsp;тип &laquo;не&nbsp;перезагружать&raquo;. Когда вам понадобится перезагрузить зону&nbsp;&#151; вы&nbsp;сможете это сделать командой <tt>zreset</tt> <tt class="arg">номер_зоны</tt>. Дело в&nbsp;том, что иммортал, которым вы,&nbsp;скорее всего, тестируете зоны&nbsp;&#151; это не&nbsp;игрок, его присутствие в&nbsp;зоне игнорируется и&nbsp;зона с&nbsp;типом перезагрузки &laquo;перегружать при отсутствии игроков&raquo; будет перезагружаться во&nbsp;время тестирования&nbsp;&#151; что мешает проверить работу квеста. Для проверки процесса перезагрузки можно позднее поставить зоне перезагрузку через 1&nbsp;минуту, только не&nbsp;забудьте перед отправкой зоны установить нужный тип и&nbsp;время перезагрузки.</p>
<p>При тестировании квеста и&nbsp;триггеров необходимо запустить системный лог командой <tt class="mud">syslog</tt> и&nbsp;при любых проблемах прежде всего обращаться к&nbsp;нему. При тестировании ошибки удобней всего искать и&nbsp;исправлять последовательно&nbsp;&#151; т.е. сначала вы&nbsp;тестите триггера приветствия (если оно есть) и&nbsp;выдачи квеста и&nbsp;так далее, по&nbsp;порядку. Для обнаружения ошибок можно использовать несколько стандартных приемов. Например, список подключенных к&nbsp;объекту триггеров и&nbsp;глобальные переменные вместе с&nbsp;их&nbsp;содержимым можно контролировать командами <tt class="mud">stat</tt> и&nbsp;<tt class="mud">stat</tt> <tt class="arg">room</tt>. Нередко проблема заключается в&nbsp;неверном значении переменной&nbsp;&#151; чтобы проконтролировать его, можно вставить в&nbsp;триггер команду типа <tt class="script">%echo%</tt> <tt class="var">%переменная%</tt>. Следующая наиболее распространенная ошибка&nbsp;&#151; порядок подключения и&nbsp;отключения триггеров.</p>
<p>При поиске ошибки в&nbsp;конкретном триггере главное&nbsp;&#151; не&nbsp;распыляться. Забудьте о&nbsp;продолжении квеста и&nbsp;том, что для него необходимо, ищите ошибку в&nbsp;конкретном триггере. Бывает, что триггер отказывается работать по&nbsp;совершенно неясным причинам&nbsp;&#151; в&nbsp;этом случае помогает тактика &laquo;закомментировать все&raquo;. Сначала закомментируйте подозрительные и&nbsp;просто &laquo;слабые&raquo; места вроде сложных многоступенчатых циклов, если это не&nbsp;помогло&nbsp;&#151; продолжайте дальше, вплоть до&nbsp;команд <tt class="script">%echo%</tt> и&nbsp;им&nbsp;подобных. Как правило, после комментирования какой-то строки триггер начинает работать&nbsp;&#151; скорее всего именно там и&nbsp;допущена ошибка. Если&nbsp;же нет, начинайте постепенно снимать комментарии. Как правило, в&nbsp;результате такого &laquo;перекрестного обстрела&raquo; ошибка обнаруживается.</p>
<p>Еще один прием&nbsp;&#151; упрощение триггера. Можно попытаться найти и&nbsp;убрать лишние проверки условий или разбить триггер на&nbsp;несколько более простых и&nbsp;подключать нужный в&nbsp;зависимости от&nbsp;ситуации.</p>
<p>Использование OLC для отладки зоны. В&nbsp;сервере &laquo;Былин&raquo; есть возможность вносить изменения в&nbsp;зоны, не&nbsp;перезапуская сервер. Это OLC&nbsp;&#151; онлайновый редактор зон. Команды OLC типа <tt class="mud">mlist</tt>, <tt class="mud">olist</tt> и&nbsp;т.д. позволяют просматривать списки мобов и&nbsp;предметов, команды типа <tt class="mud">trigedit</tt>, <tt class="mud">medit</tt>, <tt class="mud">redit</tt>, <tt class="mud">zedit</tt>&nbsp;&#151; редактировать триггера, мобов, комнаты и&nbsp;т.д. Команта <tt class="mud">attach</tt> позволяет назначать триггера. Эти команды можно использовать для существенного ускорения процесса отладки зоны&nbsp;&#151; найдя при тестировании квеста ошибку и&nbsp;исправив ее&nbsp;в&nbsp;редакторе, можно тут&nbsp;же, &laquo;на&nbsp;ходу&raquo;, исправить ее&nbsp;в&nbsp;окне иммортала и&nbsp;продолжить тестирование. Как правило, для мелких ошибок вроде неверного агрумента, опечатки в&nbsp;переменной или неназначения нужного триггера это быстрее, чем заново сохранять исправленную зону и&nbsp;перезапускать движок, не&nbsp;говоря уже о&nbsp;повторении пройденных этапов квеста.</p>

<h3>Заключение</h3>
<p>На этом пока все. Как уже было сказано выше&nbsp;&#151; замечания, просьбы о&nbsp;написании дополнительных разделов и&nbsp;расширении существующих приветствуются. Отправлять по&nbsp;мад-почте на&nbsp;имя Горраха.</p>
<p>С наилучшими пожеланиями,<br>Горрах.</p>

<p class="changedate">Текст закончен: 15.01.2004<br>Последнее изменение файла: 20.01.2004</p>
<hr>
<center class="navbar"><a href="../../index.html">История</a>&nbsp;/&nbsp;<a href="../index.html">Географическая</a>&nbsp;/&nbsp;<a href="index.html">Заметки</a>&nbsp;/&nbsp;<b>Советы по написанию триггеров</b></center>
<center class="navbar"><a href="../../index.html">Главная</a>&nbsp;|&nbsp;<a href="../../fiz/index.html">Физика</a>&nbsp;&nbsp;<b>География</b>&nbsp;&nbsp;<a href="../../clans/index.html">Политика</a>&nbsp;|&nbsp;<a href="../../sources.html">Источники</a>&nbsp;&nbsp;<a href="../../about.html">О проекте</a></center>
</body>
</html>
